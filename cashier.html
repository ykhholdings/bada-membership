<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BADA Cashier - Quick Visit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .main-content {
            background: white;
            padding: 25px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .required {
            color: #dc2626;
            font-size: 12px;
        }

        /* ê³ ê° ê²€ìƒ‰ */
        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 45px 14px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212,175,55,0.1);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #d4af37;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .search-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* ê³ ê° ì •ë³´ í‘œì‹œ */
        .customer-info {
            background: #f9fafb;
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .customer-info.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .customer-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .customer-name {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .customer-tier {
            background: #d4af37;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .customer-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 13px;
            color: #6b7280;
        }

        .customer-stats span {
            font-weight: 600;
            color: #1a1a1a;
        }

        /* ë²„íŠ¼ ê·¸ë¦¬ë“œ */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .button-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .button-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .choice-btn {
            background: white;
            border: 2px solid #e5e7eb;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }

        .choice-btn:hover {
            border-color: #d4af37;
            background: #fffbeb;
        }

        .choice-btn.selected {
            background: #d4af37;
            color: white;
            border-color: #d4af37;
        }

        .choice-btn:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            border-color: #e5e7eb;
        }

        /* ì…ë ¥ í•„ë“œ */
        input[type="number"],
        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
        }

        input:focus {
            outline: none;
            border-color: #d4af37;
        }

        input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }

        /* í˜¸í…” ì •ë³´ ì„¹ì…˜ */
        .hotel-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .hotel-section.show {
            display: block;
        }

        /* ì €ì¥ ë²„íŠ¼ */
        .save-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .save-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16,185,129,0.3);
        }

        .save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .save-btn.loading::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        /* ì„±ê³µ ë©”ì‹œì§€ */
        .success-message {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .success-message.show {
            display: block;
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            background: #fee2e2;
            border: 2px solid #dc2626;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .error-message.show {
            display: block;
        }

        /* ë¹ ë¥¸ íƒœê·¸ */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-btn {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-btn.selected {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœï¸ Quick Visit Update</h1>
            <button class="logout-btn" onclick="logout()">Dashboard</button>
        </div>

        <div class="main-content">
            <!-- ì„±ê³µ/ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>

            <!-- ê³ ê° ê²€ìƒ‰ -->
            <div class="section">
                <div class="section-title">ğŸ” Customer</div>
                <div class="search-box">
                    <input 
                        type="tel" 
                        id="phoneSearch" 
                        class="search-input" 
                        placeholder="050 123 4567 or Scan QR"
                        maxlength="15"
                    >
                    <button class="search-btn" id="searchBtn" onclick="searchCustomer()">
                        Search
                    </button>
                </div>

                <!-- ê³ ê° ì •ë³´ í‘œì‹œ -->
                <div id="customerInfo" class="customer-info">
                    <div class="customer-info-header">
                        <div class="customer-name" id="customerName">-</div>
                        <div class="customer-tier" id="customerTier">-</div>
                    </div>
                    <div class="customer-stats">
                        <div>Visits: <span id="customerVisits">0</span></div>
                        <div>Points: <span id="customerPoints">0</span></div>
                        <div>Last: <span id="customerLast">Never</span></div>
                    </div>
                </div>
            </div>

            <!-- ìœ„ì¹˜ (BADAë§Œ ìˆìœ¼ë©´ ìë™ ì„ íƒ) -->
            <div class="section">
                <div class="section-title">ğŸª Location <span class="required">*</span></div>
                <div class="button-grid-2">
                    <button class="choice-btn" data-field="location" data-value="BADA" onclick="selectChoice(this)">
                        BADA
                    </button>
                    <button class="choice-btn" data-field="location" data-value="Crazy-BJ" onclick="selectChoice(this)">
                        Crazy-BJ
                    </button>
                </div>
            </div>

            <!-- ê³ ê° ì¶œì²˜ (BADA ì„ íƒ ì‹œë§Œ í‘œì‹œ) -->
            <div class="section" id="sourceSection" style="display: none;">
                <div class="section-title">ğŸ“ Customer Source <span class="required">*</span></div>
                <div class="button-grid">
                    <button class="choice-btn" data-field="source" data-value="Hotel-Guest" onclick="selectChoice(this); showHotelSection()">
                        ğŸ¨ Hotel
                    </button>
                    <button class="choice-btn" data-field="source" data-value="Walk-in" onclick="selectChoice(this); hideHotelSection()">
                        ğŸš¶ Walk-in
                    </button>
                    <button class="choice-btn" data-field="source" data-value="Event-Guest" onclick="selectChoice(this); hideHotelSection()">
                        ğŸ‰ Event
                    </button>
                </div>

                <!-- í˜¸í…” íˆ¬ìˆ™ê° ì •ë³´ -->
                <div id="hotelSection" class="hotel-section">
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 5px;">
                            ğŸšª Room Number (optional)
                        </label>
                        <input type="text" id="roomNumber" placeholder="1205" maxlength="10">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 5px;">
                            ğŸ“… Checkout Date (optional)
                        </label>
                        <input type="date" id="checkoutDate">
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 5px;">
                            ğŸ’³ Billing
                        </label>
                        <div class="button-grid-2">
                            <button class="choice-btn" data-field="billing" data-value="Room-Charge" onclick="selectChoice(this)">
                                Room Charge
                            </button>
                            <button class="choice-btn" data-field="billing" data-value="Direct-Pay" onclick="selectChoice(this)">
                                Direct Pay
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¸ì›ìˆ˜ -->
            <div class="section">
                <div class="section-title">ğŸ‘¥ Party Size <span class="required">*</span></div>
                <div class="button-grid">
                    <button class="choice-btn" data-field="party" data-value="1" onclick="selectChoice(this)">1</button>
                    <button class="choice-btn" data-field="party" data-value="2" onclick="selectChoice(this)">2</button>
                    <button class="choice-btn" data-field="party" data-value="3" onclick="selectChoice(this)">3</button>
                    <button class="choice-btn" data-field="party" data-value="4" onclick="selectChoice(this)">4</button>
                    <button class="choice-btn" data-field="party" data-value="5" onclick="selectChoice(this)">5</button>
                    <button class="choice-btn" data-field="party" data-value="6+" onclick="selectChoice(this)">6+</button>
                </div>
            </div>

            <!-- êµ­ì  -->
            <div class="section">
                <div class="section-title">ğŸŒ Nationality</div>
                <div class="button-grid-4">
                    <button class="choice-btn" data-field="nationality" data-value="Emirati" onclick="selectChoice(this)">ğŸ‡¦ğŸ‡ª UAE</button>
                    <button class="choice-btn" data-field="nationality" data-value="Filipino" onclick="selectChoice(this)">ğŸ‡µğŸ‡­ PH</button>
                    <button class="choice-btn" data-field="nationality" data-value="Indian" onclick="selectChoice(this)">ğŸ‡®ğŸ‡³ IN</button>
                    <button class="choice-btn" data-field="nationality" data-value="Pakistani" onclick="selectChoice(this)">ğŸ‡µğŸ‡° PK</button>
                    <button class="choice-btn" data-field="nationality" data-value="Korean" onclick="selectChoice(this)">ğŸ‡°ğŸ‡· KR</button>
                    <button class="choice-btn" data-field="nationality" data-value="Chinese" onclick="selectChoice(this)">ğŸ‡¨ğŸ‡³ CN</button>
                    <button class="choice-btn" data-field="nationality" data-value="European" onclick="selectChoice(this)">ğŸ‡ªğŸ‡º EU</button>
                    <button class="choice-btn" data-field="nationality" data-value="American" onclick="selectChoice(this)">ğŸ‡ºğŸ‡¸ US</button>
                </div>
            </div>

            <!-- ë°©ë¬¸ ìœ í˜• -->
            <div class="section">
                <div class="section-title">ğŸ‘¥ Visit Type</div>
                <div class="button-grid">
                    <button class="choice-btn" data-field="visitType" data-value="Solo" onclick="selectChoice(this)">ğŸ‘¤ Solo</button>
                    <button class="choice-btn" data-field="visitType" data-value="Couple" onclick="selectChoice(this)">ğŸ’‘ Couple</button>
                    <button class="choice-btn" data-field="visitType" data-value="Family" onclick="selectChoice(this)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family</button>
                    <button class="choice-btn" data-field="visitType" data-value="Group" onclick="selectChoice(this)">ğŸ‰ Group</button>
                    <button class="choice-btn" data-field="visitType" data-value="With-Kids" onclick="selectChoice(this)">ğŸ‘¶ Kids</button>
                    <button class="choice-btn" data-field="visitType" data-value="Business" onclick="selectChoice(this)">ğŸ¢ Business</button>
                </div>
            </div>

            <!-- ë©”ë‰´ (ë‹¤ì¤‘ ì„ íƒ) -->
            <div class="section">
                <div class="section-title">ğŸ½ï¸ Menu Items (Multi-select)</div>
                <div class="quick-tags" id="menuTags">
                    <button class="tag-btn" data-field="menu" data-value="Hansang Sushi" onclick="toggleTag(this)">Hansang Sushi</button>
                    <button class="tag-btn" data-field="menu" data-value="Hansang BBQ" onclick="toggleTag(this)">Hansang BBQ</button>
                    <button class="tag-btn" data-field="menu" data-value="Ramen" onclick="toggleTag(this)">Ramen</button>
                    <button class="tag-btn" data-field="menu" data-value="Yangnyeom Chicken" onclick="toggleTag(this)">ì–‘ë…ì¹˜í‚¨</button>
                    <button class="tag-btn" data-field="menu" data-value="Tteokbokki" onclick="toggleTag(this)">ë–¡ë³¶ì´</button>
                    <button class="tag-btn" data-field="menu" data-value="Bibimbap" onclick="toggleTag(this)">Bibimbap</button>
                    <button class="tag-btn" data-field="menu" data-value="Sushi Roll" onclick="toggleTag(this)">Sushi Roll</button>
                    <button class="tag-btn" data-field="menu" data-value="Other" onclick="toggleTag(this)">Other</button>
                </div>
            </div>

            <!-- ì£¼ë¥˜ -->
            <div class="section">
                <div class="section-title">ğŸº Alcohol</div>
                <div class="button-grid-2">
                    <button class="choice-btn" data-field="alcohol" data-value="Yes" onclick="selectChoice(this)">Yes</button>
                    <button class="choice-btn" data-field="alcohol" data-value="No" onclick="selectChoice(this)">No</button>
                </div>
            </div>

            <!-- ê¸ˆì•¡ -->
            <div class="section">
                <div class="section-title">ğŸ’µ Bill Amount (optional)</div>
                <input type="number" id="billAmount" placeholder="185" min="0" step="1">
                <div id="pointsPreview" style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                    â†’ Points to earn: <span style="font-weight: 600; color: #10b981;">0</span>
                </div>
            </div>

            <!-- ë¹ ë¥¸ ë…¸íŠ¸ -->
            <div class="section">
                <div class="section-title">ğŸ“ Quick Notes (optional)</div>
                <div class="quick-tags" id="noteTags">
                    <button class="tag-btn" data-field="notes" data-value="Vegan" onclick="toggleTag(this)">ğŸ¥— Vegan</button>
                    <button class="tag-btn" data-field="notes" data-value="No-Raw" onclick="toggleTag(this)">ğŸš« No Raw</button>
                    <button class="tag-btn" data-field="notes" data-value="Spicy" onclick="toggleTag(this)">ğŸŒ¶ï¸ Spicy</button>
                    <button class="tag-btn" data-field="notes" data-value="Halal" onclick="toggleTag(this)">ğŸ¥› Halal</button>
                    <button class="tag-btn" data-field="notes" data-value="Birthday" onclick="toggleTag(this)">ğŸ‚ Birthday</button>
                    <button class="tag-btn" data-field="notes" data-value="Anniversary" onclick="toggleTag(this)">ğŸ’ Anniversary</button>
                </div>
            </div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <button class="save-btn" id="saveBtn" onclick="saveVisit()">
                ğŸ’¾ SAVE & ISSUE COUPONS
            </button>

            <div id="autoIssuedCoupons" style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 8px; display: none;">
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 5px;">ğŸ Auto-coupons to be issued:</div>
                <div id="couponsList" style="font-size: 12px; color: #92400e;"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ì„¤ì •
        // ============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwvWhJABsvtUxOHZ_yLmX-k27sJ4ZLLjCIVIWZlRRFMurzCHwyXjteS5q9GatFpEbyTfQ/exec';

        let currentCustomer = null;
        let isSubmitting = false;

        const visitData = {
            location: '',
            source: '',
            party: '',
            nationality: '',
            visitType: '',
            menu: [],
            alcohol: '',
            billAmount: 0,
            notes: [],
            roomNumber: '',
            checkoutDate: '',
            billingMethod: ''
        };

        // ============================================
        // ê³ ê° ê²€ìƒ‰
        // ============================================
        async function searchCustomer() {
            const phone = document.getElementById('phoneSearch').value.trim();
            
            if (!phone) {
                showError('Please enter phone number');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'findByPhone',
                        phone: phone
                    })
                });

                const result = await response.json();

                if (result && result.customer_id) {
                    currentCustomer = result;
                    displayCustomerInfo();
                    showSuccess('âœ… Customer found!');
                } else {
                    showError('Customer not found. Please register first.');
                    currentCustomer = null;
                    document.getElementById('customerInfo').classList.remove('show');
                }

            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed. Please try again.');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('phoneSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchCustomer();
            }
        });

        // ============================================
        // ê³ ê° ì •ë³´ í‘œì‹œ
        // ============================================
        function displayCustomerInfo() {
            document.getElementById('customerName').textContent = 
                currentCustomer.name || 'Valued Guest';
            
            document.getElementById('customerTier').textContent = 
                currentCustomer.member_tier || 'Bronze';
            
            document.getElementById('customerVisits').textContent = 
                currentCustomer.total_visits || 0;
            
            document.getElementById('customerPoints').textContent = 
                currentCustomer.available_points || 0;
            
            document.getElementById('customerLast').textContent = 
                currentCustomer.last_visit_date ? formatDateShort(currentCustomer.last_visit_date) : 'Never';

            document.getElementById('customerInfo').classList.add('show');

            // í˜¸í…” íˆ¬ìˆ™ê°ì´ë©´ ìë™ìœ¼ë¡œ ì •ë³´ ì±„ìš°ê¸°
            if (currentCustomer.current_hotel) {
                document.getElementById('roomNumber').value = currentCustomer.current_room_number || '';
                document.getElementById('checkoutDate').value = currentCustomer.checkout_date || '';
            }
        }

        // ============================================
        // ì„ íƒ ë²„íŠ¼ ë¡œì§
        // ============================================
        function selectChoice(btn) {
            const field = btn.dataset.field;
            const value = btn.dataset.value;

            // ê°™ì€ í•„ë“œì˜ ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ì„ íƒ í•´ì œ
            document.querySelectorAll(`[data-field="${field}"]`).forEach(b => {
                b.classList.remove('selected');
            });

            // í˜„ì¬ ë²„íŠ¼ ì„ íƒ
            btn.classList.add('selected');
            visitData[field] = value;

            // Locationì´ BADAë©´ source ì„¹ì…˜ í‘œì‹œ
            if (field === 'location') {
                if (value === 'BADA') {
                    document.getElementById('sourceSection').style.display = 'block';
                } else {
                    document.getElementById('sourceSection').style.display = 'none';
                    hideHotelSection();
                    visitData.source = '';
                }
            }

            // ê¸ˆì•¡ ì…ë ¥ ì‹œ í¬ì¸íŠ¸ ê³„ì‚°
            if (field === 'billAmount') {
                calculatePoints();
            }
        }

        // ë‹¤ì¤‘ ì„ íƒ íƒœê·¸
        function toggleTag(btn) {
            const field = btn.dataset.field;
            const value = btn.dataset.value;

            btn.classList.toggle('selected');

            if (btn.classList.contains('selected')) {
                visitData[field].push(value);
            } else {
                visitData[field] = visitData[field].filter(v => v !== value);
            }
        }

        // í˜¸í…” ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
        function showHotelSection() {
            document.getElementById('hotelSection').classList.add('show');
        }

        function hideHotelSection() {
            document.getElementById('hotelSection').classList.remove('show');
        }

        // ============================================
        // í¬ì¸íŠ¸ ê³„ì‚°
        // ============================================
        document.getElementById('billAmount').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value) || 0;
            const rate = visitData.location === 'BADA' ? 0.05 : 0.03;
            const points = Math.floor(amount * rate);
            
            document.querySelector('#pointsPreview span').textContent = points;
        });

        // ============================================
        // ë°©ë¬¸ ì €ì¥
        // ============================================
        async function saveVisit() {
            // ì¤‘ë³µ ì œì¶œ ë°©ì§€
            if (isSubmitting) return;

            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (!currentCustomer) {
                showError('Please search for a customer first');
                return;
            }

            if (!visitData.location) {
                showError('Please select Location');
                return;
            }

            if (!visitData.party) {
                showError('Please select Party Size');
                return;
            }

            // BADAì¸ ê²½ìš° source í•„ìˆ˜
            if (visitData.location === 'BADA' && !visitData.source) {
                showError('Please select Customer Source (for BADA)');
                return;
            }

            isSubmitting = true;
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.classList.add('loading');
            saveBtn.textContent = 'Saving...';

            try {
                const billAmount = parseFloat(document.getElementById('billAmount').value) || 0;
                
                const payload = {
                    action: 'recordVisit',
                    data: {
                        customer_id: currentCustomer.customer_id,
                        location: visitData.location,
                        party_size: parseInt(visitData.party) || 1,
                        nationality: visitData.nationality || '',
                        visit_type: visitData.visitType || '',
                        menu_items: visitData.menu.join(', '),
                        alcohol: visitData.alcohol || 'No',
                        bill_amount: billAmount,
                        dietary_prefs: visitData.notes.join(', '),
                        staff_notes: '',
                        created_by: 'Cashier',
                        customer_source: visitData.source || '',
                        room_number: document.getElementById('roomNumber').value || '',
                        billing_method: visitData.billingMethod || '',
                        checkout_date_at_visit: document.getElementById('checkoutDate').value || ''
                    }
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`âœ… Visit recorded! +${result.points_earned} points earned`);
                    
                    // í¼ ë¦¬ì…‹
                    setTimeout(() => {
                        resetForm();
                    }, 2000);
                } else {
                    showError(result.message || 'Failed to save visit');
                }

            } catch (error) {
                console.error('Save error:', error);
                showError('Connection error. Please try again.');
            } finally {
                isSubmitting = false;
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
                saveBtn.textContent = 'ğŸ’¾ SAVE & ISSUE COUPONS';
            }
        }

        // ============================================
        // í¼ ë¦¬ì…‹
        // ============================================
        function resetForm() {
            // ì„ íƒ ë²„íŠ¼ë“¤ ì´ˆê¸°í™”
            document.querySelectorAll('.choice-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.tag-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });

            // ë°ì´í„° ì´ˆê¸°í™”
            visitData.location = '';
            visitData.source = '';
            visitData.party = '';
            visitData.nationality = '';
            visitData.visitType = '';
            visitData.menu = [];
            visitData.alcohol = '';
            visitData.notes = [];

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('billAmount').value = '';
            document.getElementById('roomNumber').value = '';
            document.getElementById('checkoutDate').value = '';
            document.querySelector('#pointsPreview span').textContent = '0';

            // ê³ ê° ì •ë³´ëŠ” ìœ ì§€ (ì—°ì† ì…ë ¥ ìœ„í•´)
            // currentCustomer ìœ ì§€
        }

        // ============================================
        // ë©”ì‹œì§€ í‘œì‹œ
        // ============================================
        function showSuccess(message) {
            const div = document.getElementById('successMessage');
            div.textContent = message;
            div.classList.add('show');
            
            document.getElementById('errorMessage').classList.remove('show');
            
            setTimeout(() => {
                div.classList.remove('show');
            }, 4000);
        }

        function showError(message) {
            const div = document.getElementById('errorMessage');
            div.textContent = message;
            div.classList.add('show');
            
            document.getElementById('successMessage').classList.remove('show');
            
            setTimeout(() => {
                div.classList.remove('show');
            }, 5000);
        }

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================
        function formatDateShort(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return `${Math.floor(diffDays/7)}w ago`;
        }

        function logout() {
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>
```

**3. íŒŒì¼ ì»¤ë°‹:**
```
"Commit new file" í´ë¦­
```

---

## ğŸ¯ STEP 5 ì™„ë£Œ!

### í…ŒìŠ¤íŠ¸ ë°©ë²•:

**1. ìºì‹œì–´ í˜ì´ì§€ ì ‘ì†**
```
https://ykhholdings.github.io/bada-membership/cashier.html
```

**2. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤**
```
1. ì „í™”ë²ˆí˜¸ ê²€ìƒ‰: 50 123 9999 (ì´ì „ì— ë“±ë¡í•œ ë²ˆí˜¸)
2. "Search" í´ë¦­ â†’ ê³ ê° ì •ë³´ í‘œì‹œ
3. Location: BADA ì„ íƒ
4. Customer Source: Hotel Guest ì„ íƒ
5. Room: 1205 ì…ë ¥
6. Party Size: 2 ì„ íƒ
7. Nationality: American ì„ íƒ
8. Visit Type: Couple ì„ íƒ
9. Menu: Hansang Sushi ì„ íƒ
10. Alcohol: Yes ì„ íƒ
11. Bill Amount: 250 ì…ë ¥
12. "SAVE & ISSUE COUPONS" í´ë¦­
```

**3. í™•ì¸**
```
â†’ Google Sheets VISITS ì‹œíŠ¸ì— ìƒˆ ë°©ë¬¸ ê¸°ë¡ ì¶”ê°€
â†’ CUSTOMERS ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ê³ ê°ì˜ total_visits +1
â†’ available_points ì¦ê°€ í™•ì¸
